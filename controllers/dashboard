#! /usr/bin/ruby


cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
cookie_session_id = nil if cookie_session_id == ''

unless cookie_session_id
  puts "Content-type: text/html\n\n"
  puts %(
  <html lang="en">
    <body onload="reSignIn()"></body>
    <script>
      function reSignIn() {
        document.cookie = "session_id=;secure";
        window.location = "https://tomcalendar.com/";
      }
    </script>
  </html>
  )
  return
end

=begin
    <a href="https://tomcalendar.com" onclick="signOut()">Sign out</a>
    <a href="https://tomcalendar.com/user_settings">Settings</a>
=end

# @remember: handle refresh_tokens_and_cookie_session_id_is_valid?(cookie_session_id) during initial load and redirect to login if failed (delete cookie first)
# render dashboard
puts "Content-type: text/html\n\n"
puts %(
<html lang="en">
  <head>
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  <body>
  </body>
  <div class="navbar">
    <i class="material-icons nav create">create</i>
    <i class="material-icons nav select">person</i>
    <i class="material-icons nav select">date_range</i>
    <i class="material-icons nav select active">explore</i>
  </div>
  <script>
    function init() {
      gapi.load('auth2', function() {
        auth2 = gapi.auth2.init({
          client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
          scope: 'profile email https://www.googleapis.com/auth/calendar',
          redirect_uri: 'postmessage'
        }).then(function(then_init) {}, function(error) {});
      });
    }
    function signOut() {
      document.cookie = "session_id=;secure";
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut();
    }
  </script>
  <style>
    html {
      text-align: center;
      background-color: #DB4437;
    }
    .navbar {
      width: 100%;
      overflow: auto;
      border-bottom-style: solid;
      border-width: thin;
      border-color: rgb(240, 240, 240, .25);
      padding-bottom: 6px;
    }
    .material-icons {
      cursor: pointer;
    }
    .material-icons.nav {
      font-size: 30px;
      color: rgba(255, 255, 255, 1);
      float: right;
      text-align: center;
      margin-top: 6px;
      margin-left: 12px;
      margin-right: 12px;
      margin-bottom: 1px;
      text-shadow: 1px 1px 1px #000000;
    }
    .material-icons.nav.select {
      color: rgba(255, 255, 255, .85);
    }
    .material-icons.nav.select.active {
      color: rgba(255, 255, 255, 1);
      text-shadow: 2px 2px 1px #000000;
    }
    .material-icons.nav.create {
      padding-top: 2px;
      color: #0F9D58;
      border-style: solid;
      border-color: rgb(66, 133, 244, 1);
      border-width: thin;
      border-radius: 5px;
      background-color: #DB4437;
      margin-right: 32px;
      padding-left: 8px;
      padding-right: 8px;
      margin-top: 2px;
      padding-bottom: 3px;
    }
  </style>
</html>
)
