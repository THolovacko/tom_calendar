#! /usr/bin/ruby

require_relative '../lib/tom_calendar.rb'

# @remember: need submit consent screen for OAuth verification
# @remember: need to notify user when refresh token is not valid while auto updating google calendar  ex) if subscribed event changes date and user changed gmail password

begin
  # @remember: check header for valid X-Requested-With?

  dynamodb           = Aws::DynamoDB::Client.new(region: ENV['AWS_REGION'])
  google_authorizer  = get_google_authorizer(dynamodb)
  authorization_code = ARGF.first
  credentials        = google_authorizer.get_credentials_from_code(user_id: 'default', code: authorization_code)
  user_data          = decode_google_id_token(credentials.id_token)

  google_authorizer.store_credentials(user_data['sub'], credentials)
rescue
  credentials = nil
end

if credentials.nil?
  puts "Content-type: text/html\n\nfailed"
else
  puts "Content-type: text/html\n\nsuccess"
end
