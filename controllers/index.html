#! /usr/bin/ruby


# apache environment variables
#puts ENV['REQUEST_URI']

# stdin for post requests
#ARGF.each do |line|
#    puts line
#end



# if user is logged in redirect to dashboard (and has given permssions to access gmail and google calendar)
# else render login html (there is no signup due to using gmail)



# render login page
puts "Content-type: text/html\n\n"

puts %(
<html lang="en">
  <head>
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png">
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
  </head>
  <body>
    <button class="googleButton" id=googleLogin onclick="onSignUp()"></button>
    <a href="https://tomcalendar.com" onclick="signOut();">Sign out</a>
    <a href="https://tomcalendar.com" onclick="reset_stuff();">reset</a>
    <script>
      function init() {
        gapi.load('auth2', function(){
          auth2 = gapi.auth2.init({
            client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
            scope: 'profile email https://www.googleapis.com/auth/calendar'
          });
        });
      }
      function onSignUp() {
        auth2.grantOfflineAccess().then(onSignIn);
      }
      function onFailure() {
        console.log('failed')
      }
      function onSignIn(authResponse) {
        console.log(JSON.stringify(authResponse));
      }
      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
        console.log('User signed out.');
        });
      }
      function reset_stuff() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.disconnect();
      }
    </script>
    <style type="text/css">
      .googleButton {
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_normal_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:hover {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:active {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
    </style>
  </body>
</html>
)



