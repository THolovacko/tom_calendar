#! /usr/bin/ruby


# apache environment variables
#puts ENV['REQUEST_URI']

# stdin for post requests
#ARGF.each do |line|
#    puts line
#end



# if user is logged in redirect to dashboard (and has given permssions to access gmail and google calendar)
# else render login html (there is no signup due to using gmail)


#<div id=glogin class="g-signin2" data-onsuccess="onSignIn" data-longtitle=true data-theme="dark"></div>


# render login page
puts 'Content-type: text/html'

puts %(
<html lang="en">
  <head>
    <meta name="google-signin-scope" content="profile email https://www.googleapis.com/auth/calendar">
    <meta name="google-signin-client_id" content="#{ENV['GOOGLE_OAUTH_CLIENT_ID']}">
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
  </head>
  <body>
    <button class="button" id=glogin>Sign in with Google</button>
    <a href="https://tomcalendar.com" onclick="signOut();">Sign out</a>
    <a href="https://tomcalendar.com" onclick="reset_stuff();">reset</a>

    <script>
      function init() {
        gapi.load('auth2', function(){
          auth2 = gapi.auth2.init({
            client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
            scope: 'profile email https://www.googleapis.com/auth/calendar'
          });

          element = document.getElementById('glogin');
          auth2.attachClickHandler(element, {}, onSignUp, onFailure);
        });
      }

      function onSignUp() {
        auth2.grantOfflineAccess().then(onSignIn);
      }

      function onFailure() {
        console.log('failed')
      }

      function onSignIn(authResponse) {
        console.log(JSON.stringify(authResponse));
      }

      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
        console.log('User signed out.');
        });
      }

      function reset_stuff() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.disconnect();
      }
    </script>
  </body>
</html>
)



