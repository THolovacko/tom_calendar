#! /usr/bin/ruby


cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
cookie_session_id = nil if cookie_session_id == ''

unless cookie_session_id.nil?
  puts "Content-type: text/html\n\n"
  puts %(
  <html lang="en">
    <head>
      <meta http-equiv="Refresh" content="0; URL=https://tomcalendar.com/dashboard">
    </head>
  </html>
  )
  return
end


# render login page
puts "Content-type: text/html\n\n"

puts %(
<html lang="en">
  <title>Login</title>
  <head>
    <link rel="preload" as="image" href="https://tomcalendar.com/public/favicon.ico">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
  </head>
  <body onload="init();">
    <div class="pageTitle"><h1>TomCalendar</h1></div>
    <div class="screenshot"><img src="https://tomcalendar.com/public/dashboard_screenshot.png" alt="dashboard_screenshot" style="max-width:50%;max-height:50%;float:left;border-style:solid;"></div>
    <div class="description">
      <div class="description creator">
        <h1>You've earned your audience's attention, keep it</h1>
      </div>
      <div class="description viewer">
        <h1>Stay in the know, without spam</h1>
      </div>
    </div>
    <button class="googleButton" id=googleLogin onclick="onSignUp()"></button>
  </body>
    <script>
      function init() {
        gapi.load('auth2', function() {
          auth2 = gapi.auth2.init({
            client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
            scope: 'profile email https://www.googleapis.com/auth/calendar',
            redirect_uri: 'postmessage'
          }).then(function(then_init) {}, function(error) {});
        });
      }
      function onSignUp() {
        // @remember: on mobile authorization prompt happens twice. Maybe becasue not a popup on mobile?
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.grantOfflineAccess().then(onSignIn);
      }
      function onSignIn(authResponse) {
        if (authResponse['code']) {
          var auth2 = gapi.auth2.getAuthInstance();

          // Send the code to the server
          $.ajax({
            type: 'POST',
            url: 'https://tomcalendar.com/authorize_gmail',
            contentType: 'application/octet-stream; charset=utf-8',
            success: function(result) {
              var fail_regex = /failed/;
              if ( fail_regex.test(JSON.stringify(result)) ) {
                console.log(result)
                revoke();
              } else {
                var today_time = new Date().getTime();
                var expiration_date = new Date();
                expiration_date.setTime(today_time + (1000 *31536000));
                document.cookie = "session_id=" + JSON.stringify(result) + ";expires=" + expiration_date.toGMTString() +";secure";
                window.location = "https://tomcalendar.com/dashboard";
              }
            },
            processData: false,
            data: authResponse['code']
          });
        } else {
          console.log("Didn't find code in authResponse");
          revoke();
        }
      }
      function revoke() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.disconnect();
      }
    </script>
    <style type="text/css">
      html {
        text-align: center;
        background-color: #DB4437;
        font-family: 'Roboto', sans-serif;
      }
      h1 {
        margin: 0;
      }
      .pageTitle {
        margin-top: 16px;
        margin-bottom: 16px;
        font-size: 32px;
      }
      .description {
        max-width: 49%;
        font-size: 10px;
        float: right;
        text-align: left;
        margin: 0;
      }
      .description.viewer {
        color: white;
        text-align: left;
        float: left;
      }
      .description.creator {
        color: black;
      }
      .googleButton {
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_normal_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
        position: relative;
      }
      .googleButton:hover {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:active {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        background-size: cover;
        outline: none;
      }
    </style>
</html>
)



