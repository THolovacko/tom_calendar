#! /usr/bin/ruby


cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
cookie_session_id = nil if cookie_session_id == ''

unless cookie_session_id.nil?
  puts "Content-type: text/html\n\n"
  puts %(
  <html lang="en">
    <head>
      <meta http-equiv="Refresh" content="0; URL=https://tomcalendar.com/dashboard">
    </head>
  </html>
  )
  return
end


# render login page
puts "Content-type: text/html\n\n"

puts %(
<html lang="en">
  <head>
    <link rel="preload" as="image" href="favicon.ico">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
  </head>
  <body>
    <button class="googleButton" id=googleLogin onclick="onSignUp()"></button>
    <script>
      function init() {
        gapi.load('auth2', function() {
          auth2 = gapi.auth2.init({
            client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
            scope: 'profile email https://www.googleapis.com/auth/calendar',
            redirect_uri: 'postmessage'
          }).then(function(then_init) {}, function(error) {});
        });
      }
      function onSignUp() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.grantOfflineAccess().then(onSignIn);
      }
      function onSignIn(authResponse) {
        if (authResponse['code']) {
          var auth2 = gapi.auth2.getAuthInstance();

          // Send the code to the server
          $.ajax({
            type: 'POST',
            url: 'https://tomcalendar.com/authorize_gmail',
            contentType: 'application/octet-stream; charset=utf-8',
            success: function(result) {
              var fail_regex = /failed/;
              if ( fail_regex.test(JSON.stringify(result)) ) {
                console.log(result)
                revoke();
              } else {
                var today_time = new Date().getTime();
                var expiration_date = new Date();
                expiration_date.setTime(today_time + (1000 *31536000));
                document.cookie = "session_id=" + JSON.stringify(result) + ";expires=" + expiration_date.toGMTString() +";secure";
                window.location = "https://tomcalendar.com/dashboard";
              }
            },
            processData: false,
            data: authResponse['code']
          });
        } else {
          console.log("Didn't find code in authResponse");
          revoke();
        }
      }
      function revoke() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.disconnect();
      }
    </script>
    <style type="text/css">
      .googleButton {
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_normal_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:hover {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:active {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
    </style>
  </body>
</html>
)



