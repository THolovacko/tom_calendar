#! /usr/bin/ruby

# @optimize: requiring library is taking pretty long

require_relative '../lib/tom_calendar.rb'


cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
unless cookie_session_id.nil?
  request_ip_hash = Digest::SHA256.hexdigest "#{ENV['SESSION_HASH_LEFT_PADDING']}#{ENV['REMOTE_ADDR']}#{ENV['SESSION_HASH_RIGHT_PADDING']}"
  session_id = JSON.parse(cookie_session_id)

  # query for session
  dynamodb = Aws::DynamoDB::Client.new(region: ENV['AWS_REGION'])

  params = {
    table_name: 'Sessions',
    key: { ip_hash: request_ip_hash,
           google_id_hash: session_id['google_id_hash']
    }
  }

  begin
    result_item = dynamodb.get_item(params).item || {}
    request_password_hash = result_item['password_hash']

    # @remember: if password hash fails then delete session
    # @remember: need to reset password hash
    # @optimize: shouldn't need to validate session id twice due to redirect

    unless request_password_hash != session_id['password_hash']
      google_authorizer = get_google_authorizer(dynamodb)
      google_credentials = google_authorizer.get_credentials(result_item['google_id'])
      google_credentials.refresh! # @test: check if redundant and check if refresh token updates
      
      unless google_credentials.expired?
        puts "Content-type: text/html\n\n"
        puts %(
        <html lang="en">
          <head>
            <meta http-equiv="Refresh" content="0; URL=https://tomcalendar.com/dashboard">
          </head>
        </html>
        )
        return
      end
    end
  rescue Exception => e
    error = "#{e.message}:#{e.backtrace.inspect}"
  end
end


# render login page
puts "Content-type: text/html\n\n"

puts %(
<html lang="en">
  <head>
    <link rel="preload" as="image" href="favicon.ico">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
  </head>
  <body>
    <button class="googleButton" id=googleLogin onclick="onSignUp()"></button>
    <a href="https://tomcalendar.com" onclick="signOut()">Sign out</a>
    <a href="https://tomcalendar.com" onclick="revoke()">revoke</a>
    <script>
      function init() {
        gapi.load('auth2', function(){
          auth2 = gapi.auth2.init({
            client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
            scope: 'profile email https://www.googleapis.com/auth/calendar',
            redirect_uri: 'postmessage'
          }).then(function(then_init) {}, function(error) {});
        });
      }
      function onSignUp() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.grantOfflineAccess().then(onSignIn);
      }
      function onSignIn(authResponse) {
        if (authResponse['code']) {
          var auth2 = gapi.auth2.getAuthInstance();

          // Send the code to the server
          $.ajax({
            type: 'POST',
            url: 'https://tomcalendar.com/authorize_gmail',
            contentType: 'application/octet-stream; charset=utf-8',
            success: function(result) {
              var fail_regex = /failed/;
              if ( fail_regex.test(JSON.stringify(result)) ) {
                console.log(result)
                revoke();
              } else {
                var today_time = new Date().getTime();
                var expiration_date = new Date();
                expiration_date.setTime(today_time + (1000 *31536000));
                document.cookie = "session_id=" + JSON.stringify(result) + ";expires=" + expiration_date.toGMTString() +";secure";
                window.location = "https://tomcalendar.com/dashboard";
              }
            },
            processData: false,
            data: authResponse['code']
          });
        } else {
          console.log("Didn't find code in authResponse");
          revoke();
        }
      }
      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
          console.log('User signed out.');
        });
        // remove session in db
      }
      function revoke() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.disconnect();
      }
    </script>
    <style type="text/css">
      .googleButton {
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_normal_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:hover {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_focus_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
      .googleButton:active {
        cursor: pointer;
        display: inline-block;
        width: 250px;
        height: 60px;
        white-space: nowrap;
        border: none;
        background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png') no-repeat;
        background-size: cover;
        border-radius: 3px;
      }
    </style>
  </body>
</html>
)



