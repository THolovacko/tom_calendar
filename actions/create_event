#! /usr/bin/ruby

require_relative '../lib/tom_calendar.rb'

#https://developers.google.com/calendar/create-events
#https://developers.google.com/calendar/v3/reference/events

cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
cookie_session_id = nil if cookie_session_id == ''

unless cookie_session_id
  print StatusCodeStr::BAD_REQUEST
  return
end

session_id    = JSON.parse(cookie_session_id)
request_input = JSON.parse(ARGF.first)

event = request_input
event['title'] = event['title']&.strip
event['google_id'] = session_id['google_id']

unless ( event['title'] && (event['title'] != '') )
  print StatusCodeStr::BAD_REQUEST
  return;
end

begin
  dynamodb = Aws::DynamoDB::Client.new(region: ENV['AWS_REGION'])

  check_event_params = {
    table_name: 'Events',
    key: { google_id: event['google_id'], title: event['title'] }
  }

  result_item = dynamodb.get_item(check_event_params)&.item
  if (result_item)
    print StatusCodeStr::BAD_REQUEST
    return;
  end

  event_params = {
    table_name: 'Events',
    item: event
  }

  dynamodb.put_item(event_params)
rescue Exception => e
  raise e
end

print "Content-type: application/json\n\n#{event.to_json}"
