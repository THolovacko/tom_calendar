#! /usr/bin/ruby

# @remember: use image(screenshot)?
# @current: create custom google sign-in button with: https://developers.google.com/identity/sign-in/web/build-button and https://developers.google.com/identity/branding-guidelines


cookie_session_id = ENV['HTTP_COOKIE']&.split(';')&.find{ |cookie| cookie.match?('session_id') }&.sub('session_id=','')&.strip
cookie_session_id = nil if cookie_session_id == ''

unless cookie_session_id.nil?
  print "Content-type: text/html\n\n"
  print %(
  <html lang="en">
    <head>
      <meta http-equiv="Refresh" content="0; URL=https://tomcalendar.com/dashboard">
    </head>
  </html>
  )
  return
end

user_agent_str = ENV['HTTP_USER_AGENT'].downcase
IS_DESKTOP  = !( /phone|android/.match(user_agent_str) )
VW_FACTOR   = IS_DESKTOP ? 0.6 : 1
VH_FACTOR   = IS_DESKTOP ? 1.8 : 1
FONT_FACTOR = IS_DESKTOP ? 0.7 : 1


print "Content-type: text/html\n\n"
print %(
<html lang="en">
  <title>Login</title>
  <head>
    <link rel="preload" as="image" href="https://tomcalendar.com/public/favicon.ico">
    <link rel="preload" as="image" href="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
  </head>
  <body onload="init();" id="background">
    <div class="firefox_hack"><img src="https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png" alt="firefox_hack" style="display:none;"></div>
    <div id="description_and_button">
      <div id="logo_txt"><h1>TomCalendar</h1></div>
      <div id="description">
        <div id="description_content">
          <h1>You've earned your audience's attention, keep it.</h1><br>
          <h1>Stay in the know, without spam.</h1>
        </div>
      </div>
      <br>
      <div id="google_button_wrapper">
        <!-- <button class="google_button" id="google_login" onmousedown="onSignUp()"></button> using ontouchstart breaks google sign in (popup window is blocked) -->
        <div id="google_sign_in_button">
          <img style="height:50px; vertical-align:middle;" src="https://tomcalendar.com/public/google_signin_buttons/web/vector/btn_google_light_normal_ios.svg"></img>
          <span style="font-size:16px;margin-left:18px;margin-right:26px;">Sign in with Google</span>
        </div>
      </div>
    </div>
  </body>
  <script>
    function init() {
      gapi.load('auth2', function() {
        auth2 = gapi.auth2.init({
          client_id: '#{ENV['GOOGLE_OAUTH_CLIENT_ID']}',
          scope: 'profile email https://www.googleapis.com/auth/calendar',
          redirect_uri: 'postmessage'
        }).then(function(then_init) {
        /*
          gapi.signin2.render('google_login', {
            'scope': 'profile email https://www.googleapis.com/auth/calendar',
            'width': 240,
            'height': 50,
            'longtitle': true,
            'theme': 'dark',
            'onsuccess': onSuccess,
            'onfailure': onFailure
          }); 
          document.getElementById("tomcalendar-signin2-btn").disabled = true;
        */
        }, function(error) {});
      });
    }
    //function onSuccess(googleUser) {
    //  console.log('Logged in as: ' + googleUser.getBasicProfile().getName());
    //}
    //function onFailure(error) {
    //  console.log(error);
    //  //revoke();
    //}
    function onSignUp() {
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.grantOfflineAccess().then(onSignIn);
    }
    function onSignIn(authResponse) {
      if (authResponse['code']) {
        var auth2 = gapi.auth2.getAuthInstance();

        $.ajax({
          type: 'POST',
          url: 'https://tomcalendar.com/authorize_gmail',
          contentType: 'application/octet-stream; charset=utf-8',
          success: function(result) {
            var today_time = new Date().getTime();
            var expiration_date = new Date();
            expiration_date.setTime(today_time + (1000 *31536000));
            document.cookie = "session_id=" + JSON.stringify(result) + ";expires=" + expiration_date.toGMTString() +";secure";
            window.location = "https://tomcalendar.com/dashboard";
          },
          error: function(result) {
            revoke();
          },
          processData: false,
          data: authResponse['code']
        });

        document.getElementById("background").style.webkitFilter = "blur(100px)";
      } else {
        // Didn't find code in authResponse
        revoke();
      }
    }
    function revoke() {
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.disconnect();
      window.location = "https://tomcalendar.com";
    }
  </script>
  <style type="text/css">
    html {
      text-align: center;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
    }
    h1 {
      margin: 0;
    }
    body {
      transition: all 10s;
      transition-timing-function: ease-out;
    }
    #description_and_button {
      margin-top: #{16 * VH_FACTOR}vh;
    }
    #logo_txt {
      font-size: #{3 * FONT_FACTOR}rem;
      font-weight: bold;
    }
    #description {
      display: inline-block;
    }
    #description_content {
      text-align: center;
      font-size: #{1.15 * FONT_FACTOR}rem;
      margin-top: #{3 * VH_FACTOR}vh;
      font-weight: normal;
    }
    #google_button_wrapper {
      display: inline-block;
      margin-top: #{3 * VH_FACTOR}vh;


      background-color: #4285F4;
      border: none;
      border-radius: 2px;
      transition: box-shadow .175s;
    }
    #google_button_wrapper:hover {
      box-shadow: 0px 0px 4px #4285F4;
      cursor: pointer;
    }
    .google_button {
      width: #{60 * VW_FACTOR}vw;
      height: #{7 * VH_FACTOR}vh;
      border: none;
      background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_normal_web@2x.png') no-repeat;
      background-size: cover;
      border-radius: 3px;
      cursor: pointer;
      transition: background .175s;
      transition-timing-function: ease-out;
    }
    .google_button:hover {
      background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png') no-repeat;
      background-size: cover;
    }
    .google_button:active {
      background: url('https://tomcalendar.com/public/google_signin_buttons/web/2x/btn_google_signin_dark_pressed_web@2x.png') no-repeat;
      background-size: cover;
    }
    #google_sign_in_button {
      color: #FFFFFF;
    }
  </style>
</html>
)
